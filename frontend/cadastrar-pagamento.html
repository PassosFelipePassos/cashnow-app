<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Acompanhamento de Pagamentos - CashNow</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>

<!-- Cabe√ßalho com Logo -->
<header class="header">
    <div class="menu-icon" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
    </div>
    <img src="images/Logo.png" alt="CashNow" class="header-logo">
</header>

<!-- Menu Lateral -->
<nav class="menu" id="sidebar">
    <ul>
        <li><a href="cadastrar-cliente.html">Cadastrar Novo Cliente</a></li>
        <li><a href="novo-emprestimo.html">Novo Empr√©stimo</a></li>
        <li class="active"><a href="acompanhamento-emprestimos.html">Acompanhamento de Empr√©stimos</a></li>
        <li><a href="cadastrar-pagamento.html">Cadastrar Pagamento</a></li>
        <li><a href="index.html">Sair</a></li>
    </ul>
</nav>

<!-- Tabela de Pagamentos -->
<div class="container">
    <div class="form-box">
        <h2>Acompanhamento de Pagamentos</h2>
        <table id="tabelaPagamentos">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <!-- Colunas das datas ser√£o preenchidas dinamicamente -->
                </tr>
            </thead>
            <tbody>
                <!-- Dados dos pagamentos ser√£o preenchidos dinamicamente -->
            </tbody>
        </table>
    </div>
</div>

<script>
    function toggleMenu() {
        document.getElementById("sidebar").classList.toggle("active");
    }

    async function carregarPagamentos() {
        try {
            const response = await fetch("https://cashnow-app.onrender.com/listar-pagamentos");
            const pagamentos = await response.json();

            const tabela = document.getElementById("tabelaPagamentos");
            const thead = tabela.querySelector("thead tr");
            const tbody = tabela.querySelector("tbody");

            tbody.innerHTML = ""; // Limpa a tabela antes de carregar os dados

            let colunasDatas = new Set();

            // Organiza pagamentos por cliente
            const pagamentosPorCliente = {};
            pagamentos.forEach(pagamento => {
                if (!pagamentosPorCliente[pagamento.nome_cliente]) {
                    pagamentosPorCliente[pagamento.nome_cliente] = [];
                }
                pagamentosPorCliente[pagamento.nome_cliente].push(pagamento);
                colunasDatas.add(pagamento.data);
            });

            // Adiciona as colunas de datas dinamicamente
            thead.innerHTML = "<th>Cliente</th>";
            Array.from(colunasDatas).sort().forEach(data => {
                thead.innerHTML += `<th>${data}</th>`;
            });

            // Preenche os pagamentos na tabela
            for (let cliente in pagamentosPorCliente) {
                let row = `<tr><td>${cliente}</td>`;

                Array.from(colunasDatas).sort().forEach(data => {
                    let pagamento = pagamentosPorCliente[cliente].find(p => p.data === data);
                    if (pagamento) {
                        let cor = pagamento.status === "Pago" ? "green" : 
                                  (new Date(pagamento.data) < new Date() && pagamento.status === "Aberto") ? "red" : 
                                  "gray";
                        
                        row += `<td style="background-color: ${cor}; color: white; text-align: center; cursor: pointer;" onclick="confirmarPagamento(${pagamento.idpagamento})">
                                    R$ ${pagamento.valor.toFixed(2)}
                                </td>`;
                    } else {
                        row += "<td></td>";
                    }
                });

                row += "</tr>";
                tbody.innerHTML += row;
            }

        } catch (error) {
            console.error("Erro ao carregar pagamentos:", error);
        }
    }

    async function confirmarPagamento(idpagamento) {
        if (confirm("Deseja confirmar o pagamento desta parcela?")) {
            try {
                const response = await fetch(`https://cashnow-app.onrender.com/confirmar-pagamento/${idpagamento}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" }
                });

                const data = await response.json();
                if (data.success) {
                    alert("Pagamento confirmado com sucesso!");
                    carregarPagamentos(); // Atualiza a tabela ap√≥s confirmar
                } else {
                    alert("Erro ao confirmar pagamento: " + data.message);
                }
            } catch (error) {
                console.error("‚ùå Erro ao confirmar pagamento:", error);
            }
        }
    }

    document.addEventListener("DOMContentLoaded", carregarPagamentos);
	
	async function carregarPagamentos() {
    try {
        const response = await fetch("https://cashnow-app.onrender.com/listar-pagamentos");
        const pagamentos = await response.json();

        console.log("üìä Pagamentos recebidos:", pagamentos); // Debug no console

        const tabela = document.getElementById("tabelaPagamentos");
        const thead = tabela.querySelector("thead tr");
        const tbody = tabela.querySelector("tbody");

        tbody.innerHTML = ""; // Limpa a tabela antes de carregar os dados

        let colunasDatas = new Set();

        // Organiza pagamentos por cliente
        const pagamentosPorCliente = {};
        pagamentos.forEach(pagamento => {
            if (!pagamentosPorCliente[pagamento.nome_cliente]) {
                pagamentosPorCliente[pagamento.nome_cliente] = [];
            }
            pagamentosPorCliente[pagamento.nome_cliente].push(pagamento);
            colunasDatas.add(pagamento.data_pagamento);
        });

        // Adiciona as colunas de datas dinamicamente
        thead.innerHTML = "<th>Cliente</th>";
        colunasDatas = Array.from(colunasDatas).sort();
        colunasDatas.forEach(data => {
            thead.innerHTML += `<th>${formatarData(data)}</th>`;
        });

        // Preenche os pagamentos na tabela
        for (let cliente in pagamentosPorCliente) {
            let row = `<tr><td>${cliente}</td>`;

            colunasDatas.forEach(data => {
                let pagamento = pagamentosPorCliente[cliente].find(p => p.data_pagamento === data);
                if (pagamento) {
                    let cor = pagamento.status === "Pago" ? "green" : 
                              (new Date(pagamento.data_pagamento) < new Date() && pagamento.status === "Aberto") ? "red" : 
                              "gray";

                    row += `<td style="background-color: ${cor}; color: white; text-align: center; cursor: pointer;" onclick="confirmarPagamento(${pagamento.idpagamento})">
                                R$ ${pagamento.valor.toFixed(2)}
                            </td>`;
                } else {
                    row += "<td></td>";
                }
            });

            row += "</tr>";
            tbody.innerHTML += row;
        }

    } catch (error) {
        console.error("Erro ao carregar pagamentos:", error);
    }
}

// Fun√ß√£o para formatar a data no formato DD/MM/AAAA
function formatarData(data) {
    const dataObj = new Date(data);
    return dataObj.toLocaleDateString("pt-BR");
}

async function confirmarPagamento(idpagamento) {
    if (confirm("Deseja confirmar o pagamento desta parcela?")) {
        try {
            const response = await fetch(`https://cashnow-app.onrender.com/confirmar-pagamento/${idpagamento}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" }
            });

            const data = await response.json();
            if (data.success) {
                alert("Pagamento confirmado com sucesso!");
                carregarPagamentos(); // Atualiza a tabela ap√≥s confirmar
            } else {
                alert("Erro ao confirmar pagamento: " + data.message);
            }
        } catch (error) {
            console.error("‚ùå Erro ao confirmar pagamento:", error);
        }
    }
}

// Carrega os pagamentos ao carregar a p√°gina
document.addEventListener("DOMContentLoaded", carregarPagamentos);

	
</script>

</body>
</html>
